<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<title>The CoffeeMUD Web Server</title>
</head>

<body>

<p><b>The CoffeeMUD Web Server:</b><br>
The CoffeeMUD Web Server is a simple, extensible 
web server that runs as part of CoffeeMUD; it uses HTTP 1.0 
to communicate with a web browser. In addition to being able to 
serve standard HTML web pages, it allows mime-types to be specified 
for any file extension; it also supports a simple server-processed form of HTML
called <i>CMVP</i> (Coffee MUD Virtual Pages) - this allows the server 
to insert information into the page before sending it to the browser.  
It is NOT intended to be a full-blown web server! This document assumes you have
some familiarty with HTTP, mime types, and stuff like that.</p>
<P><STRONG>How to Connect:</STRONG><BR>By default, the public web site listens 
on port 27744 and the administrative web site on port 27777.&nbsp; To browse the 
default public web site, just open up the following URL in your 
browser:<BR><BR><A 
href="http://localhost:27744/">http://localhost:27744/</A></P>
<P>To connect to the administrative web site, use the following URL:</P>
<P><A href="http://localhost:27777/">http://localhost:27777/</A></P>

<p><b>What it does and doesn't do:</b><br>
It only supports GET, POST&nbsp;and HEAD 
requests (I think HEAD is HTTP 1.1, but it's supported anyway).&nbsp; 
It does not cache.
</p>

<p><b>Security:</b><br>
In the default CoffeeMUD installation, the server named admin&nbsp;may be&nbsp;bound to 127.0.0.1 (localhost) - this
means it will not accept external connections (see below).<br>
The servers will not permit access to a directory or file outside their base directory tree (which 
includes mounted virtual directories, see below); attempts will generate a log message and return
a HTTP 401.
</p>


<p><b>Configuration:</b><br>
The default installation of CoffeeMUD has two inbuilt web servers, named 'pub' and 'admin'.
The web servers are enabled with the line 'RUNWEBSERVERS=true' in 'coffeemud.ini'; any other
value or the abscence of this line will cause the web servers not to be loaded.</p>
<p>INI files for the web servers live in the 'web/' directory off the CoffeeMUD root; by default, 
all pages to be served go in <I>web/(servername)/</I>, though this can be overridden. 
Options are placed in either 'web/common.ini' or 'web/(servername).ini'; an option in the latter
will override one in common.
The options are:
</p>
<ul>
	<li><b>PORT</b>=xx : 
			<b>[REQUIRED]</b>
			<i>(e.g. PORT=80)</i>
			Sets the port number the web server will listen for HTTP requests on; 
			this cannot be the same port as the main MUD server or another web servers.
			Identical to MUD server usage.
			Normally this would go in <I>web/(servername).ini</I>.
	<li><b>BACKLOG</b>=xx : 
			<i>(e.g. BACKLOG=10)</i>
			Sets the number of requests that can be 
			queued by the internal TCP/IP stack. Identical to MUD server usage.
	<li><b>BIND</b>=addr : 
			<i>(e.g. BIND=127.0.0.1)</i>
			Causes the server to be bound to a 
			specific address; this is useful on multi-homed machines or if you wish to prevent
			public access to the pages. Identical to MUD server usage.<br>
			<b>The Admin server should be bound to localhost (or 127.0.0.1) unless you really know
			what you're doing...</b>

	<li><b>DEFAULTFILE</b>=filename : 
			<b>[REQUIRED]</b> 
			<i>(e.g. DEFAULTFILE=index.html)</i>
			Sets the default filename to be appended if none is specified in the 
			request (or the request refers to a directory - in which case the browser 
			will get a 401 Unauthorized rather than a 404 Not Found if this file doesn't exist).
	<li><b>VIRTUALPAGEEXTENSION</b>=.xxxx : 
			<b>[REQUIRED]</b> 
			<i>(e.g. VIRTUALPAGEEXTENSION=CMVP)</i> 
			Allows you to change the file extension for server-processed files to whatever takes
			your fancy. Note that the leading dot is required; you should 
			set MIME.xxxx=text/html, unless you're being clever and serving server-processed plaintext 
			or something. At the moment, the web server only supports one VIRTUALPAGEEXTENSION.
	<li><b>MIME.xxxx</b>=.yyyy/zzzz : 
			<b>[A GOOD IDEA TO SPECIFY!]</b>
			<i>(e.g. MIME.HTML=text/html, MIME.JPEG=image/jpg)</i> 
			Allows you to specify a mime type for file extension xxxx;
			some useful mime types include <code>text/html</code>, <code>text/plain</code>, <code>image/gif</code>
			and <code>image/jpg</code>.  If no
			mime type is specified for an extension, it defaults to <code>application/octet-stream</code> - 
			which is to say, raw binary; for this reason, it's usually a good idea to specify
			at least <code>MIME.HTM=text/html</code> and <code>MIME.HTML=text/html</code> - 
			it's also good manners to specify <code>MIME.CLASS=application/octet-stream</code> if you 
			intend to be running java applets on the web pages.
			Normally these would be placed in <I>web/common.ini</I>.
	<li><b>ADMIN</b>=   true : allows admin macros to run on this server (see below).
	<li><b>BASEDIRECTORY</b>=path : allows you to override the web-page directory that this server 
			uses - default is <i>web/(servername)</i>. Servers can share base directories.
	<li><b>TEMPLATEDIRECTORY</b>=path : allows you to override the web-page template directory that this server 
			uses - default is BASEDIRECTORY + <i>.templates</i>.  
			The template directory is where pages such as <I>error.cmvp</I> are 
  placed. Servers can share template directories.</li>  
			    
</ul>

<p><b>Virtual Directories:</b><br>
This is a quick-and-dirty directory mounting method; using an operating-system specific method would
be preferable. Nevertheless, you can specify <B>MOUNT/virtualdir=physicaldir</B> in a server cfg file;
for example, <B>MOUNT/guides=guides</B> creates a virtual directory with access to the player guides.<br>
Now the limitation - URLs that do things like this: <B>/guides/..</B> won't work; this means you can't
link BACK from a virtual directory with a RELATIVE link, unless you rely on the user's browser to preprocess the URL and 
remove redundancies; instead, specify a path from the root ('/') - 
e.g., instead of ../index.cmvp specify /index.cmvp.
</p>
<P><b>CoffeeMUD Virtual Pages:</b><br>
  Kind of misnamed (these pages in their original, very 
different incarnation didn't exist at all), this is typically a HTML or 
plaintext file that is preprocessed by the server before being dispatched to the 
browser. Preprocessing is a simple search-and-replace; NO ACCOUNT is taken of 
where the macro appears within the file (ie, macros within comments or quoted 
strings will be replaced). </P>
<P>Macros are always surrounded by the AT sign (@), and are thus delineated in 
the page.&nbsp; Any parameters required for a macro always follow the macro name 
and a Question Mark (?).&nbsp; Further parameters are seperated by the Ampersand 
(&amp;) character.&nbsp; Each parameter may optionally be an equation, where the 
name is on the left of an equal sign, and its value on the right.&nbsp; An 
example of all this in action would be:</P>
<P>@MacroName?PARAMETER&amp;PARM2=VALUE&amp;PARM3@</P>
<P>Macros may be embedded in each other ONLY if the embedded macros are part of 
the parameters of the host macro, which means they must follow&nbsp;the Question 
Mark.&nbsp;&nbsp; Also, for each level of embedding, an extra At sign (@) 
character is used around the macro.&nbsp; To avoid confusion, the closing At 
signs (@) should be seperated by spaces.&nbsp; Here is an example of embedded 
Macros (in this case, two macros are used for each of two parameters to a first 
macro (MacroOne):</P>
<P>@MacroOne?@@MacroTwo?PARM@@&amp;@@MacroThree?PARM@@ @</P>
<P>Notice the space before the final At sign (@).&nbsp; Now, here is an example 
of double-embedding, where MacroThree is embedded as the parameter to MacroTwo, 
which is embedded as the parameter to MacroOne:</P>
<P>@MacroOne?@@MacroTwo?@@@MacroThree?PARM@@@ @@ @</P>
<P>Here are the macros defined so far.&nbsp; Keep in mind 
the difference between a Macro parameter (things which follow the first Question 
mark in a macro), and a Request Parameter (data submitted from a &lt;FORM&gt; on 
a web page, or on the URL line of a GET request).</P>
<TABLE BORDER=1 WIDTH="100%">
<TR><TD WIDTH="25%"><B>Macro</B></TD><TD><B>Description&gt;</B></TD></TR>
<TR><TD>AbilityAffectNext</TD><TD></TD></TR>
<TR><TD>AbilityData</TD><TD></TD></TR>
<TR><TD>AbilityDomainNext</TD><TD></TD></TR>
<TR><TD>AbilityID</TD><TD></TD></TR>
<TR><TD>AbilityName</TD><TD></TD></TR>
<TR><TD>AbilityPlayerNext</TD><TD></TD></TR>
<TR><TD>AbilityTypeNext</TD><TD></TD></TR>
<TR><TD>AddFile</TD><TD>The parameters for this macro are a list of file 
      names.&nbsp; Inserts the contents of the files&nbsp; into the current 
      document.</TD></TR>
<TR><TD>AddRequestParameter</TD><TD>  The parameters for this macro are one 
      or more Request Parameter names and values.&nbsp; 
      Forexample@AddRequestParameter?PARM1=VALUE&amp;PARM2=VALUE@.&nbsp; This is usually 
      used to provide literal data for other macros which may require certain 
      Request parameter data.</TD></TR>
<TR><TD>AreaData</TD><TD></TD></TR>
<TR><TD>AreaName</TD><TD></TD></TR>
<TR><TD>AreaNameEncoded</TD><TD></TD></TR>
<TR><TD>AreaNext</TD><TD></TD></TR>
<TR><TD>AreaTbl</TD><TD> Returns a formatted HTML table containing all the areas currently installed in the
		game; as with @PLAYERLIST@, the enclosing &lt;TABLE&gt;..&lt;/TABLE&gt; must still be 
		specified. Each &lt;TD&gt; element has style-sheet class <I>cmAreaTblEntry</I>. 
      The area list may only be obtained while the mud server is running; 
      otherwise a simple table containing a game-not-running message is 
      returned.</TD></TR>
<TR><TD>Authenticate</TD><TD></TD></TR>
<TR><TD>back</TD><TD>Denotes the looping point for a @loop@ block.&nbsp; 
      See the @loop@ macro.</TD></TR>
<TR><TD>BanListMgr</TD><TD></TD></TR>
<TR><TD>BaseCharClassName</TD><TD></TD></TR>
<TR><TD>BaseCharClassNext</TD><TD></TD></TR>
<TR><TD>BehaviorNext</TD><TD></TD></TR>
<TR><TD>break</TD><TD>Stops inserting text into a web page at the current 
      point, skips ahead to the next @back@ macro found, and starts again.&nbsp; 
      If no @back@ macro is found, the page will not continue to be 
      evaluated.&nbsp; See the @loop@ macro.&nbsp; This macro is actually 
      returned by many other macros as a means of creating breaks in 
loops.</TD></TR>
<TR><TD>CharClassData</TD><TD></TD></TR>
<TR><TD>CharClassID</TD><TD></TD></TR>
<TR><TD>CharClassName</TD><TD></TD></TR>
<TR><TD>CharClassNext</TD><TD></TD></TR>
<TR><TD>CheckReqParm</TD><TD>Evaluates to the string "true" if the specified 
      Request parameters is equal to the values for them&nbsp;given. For 
      example, @CheckReqParm?PARM=VALUE@ would return "true" if the PARM request 
      parameter is "VALUE", and "false" otherwise.&nbsp; See the @if?@ macro for 
      more information on how this may be useful.</TD></TR>
<TR><TD>ChkReqParmBreak</TD><TD>Evaulates to the string " @break@" (see&nbsp;the 
      break macro) if the specified Request parameters are NOT equal to the 
      values given.&nbsp; It returns "" otherwise.&nbsp; For example, 
      @ChkReqParmBreak?PARM=VALUE@ would return "" if PARM is equal to VALUE, 
      and @break@ otherwise. See the @loop@ macro for more information on how 
      this might be useful.</TD></TR>
<TR><TD>ClassRaceNext</TD><TD></TD></TR>
<TR><TD>CrossClassAbilities</TD><TD></TD></TR>
<TR><TD>else</TD><TD>Creates an exception to an @if?@ macro.</TD></TR>
<TR><TD>endif</TD><TD>Denotes the end of an @if?@ block.&nbsp; See the 
      @if?@ macro.</TD></TR>
<TR><TD>ExitData</TD><TD></TD></TR>
<TR><TD>HelpTopics</TD><TD></TD></TR>
<TR><TD>HTTPclientIP</TD><TD>Returns the client's IP address.</TD></TR>
<TR><TD>HTTPstatus</TD><TD>Returns the http return code; this is normally of 
      no use ("200 OK") unless customising the error page.</TD></TR>
<TR><TD>HTTPstatusInfo</TD><TD>Returns additional http status information; this is 
      normally of no use unless customising the error page.</TD></TR>
<TR><TD>if</TD><TD>The Single, Required&nbsp;parameter for this 
      macro is another macro name&nbsp;which evaluates to the words "true" or 
      something else (which is defined as false).&nbsp;That macro does not 
      follow the embedding rules above.&nbsp; This macro requires an @endif@ 
      macro, and may optionally have an @else@ macro.&nbsp; The "!" character 
      may follow the "?" to negate the value of the expression.&nbsp; For 
      example: @if?CheckReqParm?PARM=VALUE@&nbsp; @if?!CheckReqParm?PARM=VALUE@ 
      would return true and false (or vis-versa) depending whether the request 
      parameter PARM was equal to VALUE.</TD></TR>
<TR><TD>ItemData</TD><TD></TD></TR>
<TR><TD>JournalFunction</TD><TD></TD></TR>
<TR><TD>JournalInfo</TD><TD></TD></TR>
<TR><TD>JournalMessageNext</TD><TD></TD></TR>
<TR><TD>JournalName</TD><TD></TD></TR>
<TR><TD>JournalNext</TD><TD></TD></TR>
<TR><TD>LevelNext</TD><TD></TD></TR>
<TR><TD>LevelNumber</TD><TD></TD></TR>
<TR><TD>LogViewer</TD><TD></TD></TR>
<TR><TD>loop</TD><TD>Repeatedly inserts into the page the contents 
      between this macro and the corresponding @back@ until a @break@ macro 
      located inside the block is processed.&nbsp; This @break@ string is most 
      often returned by a macro processed within the block, but may also be 
      embedded in an @if?@ macro block as well.</TD></TR>
<TR><TD>MobData</TD><TD></TD></TR>
<TR><TD>MUDGrinder</TD><TD>The main processing macro for the MUDGrinder 
      area-editing tool.&nbsp; This macro runs as an admin macro.&nbsp; See the 
      MUDGrinder guide for more information.&nbsp; There are too many parameters 
      and options here to mention.</TD></TR>
<TR><TD>MUDServerPort</TD><TD>Returns the port number the mud server is running 
      on.</TD></TR>
<TR><TD>MUDServerStatus</TD><TD>Returns a string showing the status of the mud 
      server (note that there's no WEB equivalent - if it wasn't running, you 
      wouldn't be able to see it!)</TD></TR>
<TR><TD>MUDServerVersion</TD><TD>Returns the name and version of the mud 
  server.</TD></TR>
<TR><TD>NumPlayers</TD><TD>Returns the number of players online which can be 
      seen (no WizInvisibles)</TD></TR>
<TR><TD>PlayerData</TD><TD></TD></TR>
<TR><TD>PlayerDelete</TD><TD></TD></TR>
<TR><TD>PlayerID</TD><TD></TD></TR>
<TR><TD>PlayerList</TD><TD>Returns a series of HTML &lt;LI&gt; elements; the 
      enclosing list elements (&lt;UL&gt;..&lt;/UL&gt; or 
      &lt;OL&gt;..&lt;/OL&gt;) are not part of this string and so must be 
      defined in the surronding page. Additionally, each element will have their 
      style-sheet class set to either <I 
      >cmPlayerListEntry</I> or, if applicable, <I 
      >cmPlayerListEntryArchon</I>.</TD></TR>
<TR><TD>PlayerNext</TD><TD></TD></TR>
<TR><TD>PlayerOnline</TD><TD></TD></TR>
<TR><TD>QuestData</TD><TD></TD></TR>
<TR><TD>QuestMgr</TD><TD></TD></TR>
<TR><TD>QuestNext</TD><TD></TD></TR>
<TR><TD>RaceClassNext</TD><TD></TD></TR>
<TR><TD>RaceData</TD><TD></TD></TR>
<TR><TD>RaceID</TD><TD></TD></TR>
<TR><TD>RaceName</TD><TD></TD></TR>
<TR><TD>RequestParameter</TD><TD>Inserts the&nbsp;value of the Request Parameter(s) 
      specified in the macro parameters.</TD></TR>
<TR><TD>RequestParameterEncoded</TD><TD>Inserts the value of the Request Parameter(s) 
      specified in the macro parameters, formatted for a valid GET 
request.</TD></TR>
<TR><TD>RequestParametersEncoded</TD><TD>Inserts the names and values of all Request 
      Parameters, formatted for a valid GET request.</TD></TR>
<TR><TD>ResourceMgr</TD><TD></TD></TR>
<TR><TD>RoomData</TD><TD></TD></TR>
<TR><TD>RoomID</TD><TD></TD></TR>
<TR><TD>RoomName</TD><TD></TD></TR>
<TR><TD>StdWebMacro</TD><TD></TD></TR>
<TR><TD>SystemInfo</TD><TD></TD></TR>
<TR><TD>WebServerName</TD><TD></TD></TR>
<TR><TD>WebServerPort</TD><TD>Returns the port number the web server is running 
      on.</TD></TR>
<TR><TD>WebServerVersion</TD><TD>Returns the name and version of the web 
  server.</TD></TR>
</TABLE>     
      
  <P><b>Customising the error page:</b><br>
Simply create a file <I>error.cmvp</I> (or 
whatever the v.p. extension is) in the template directory of the server; at some 
point on the page you should use the @HTTPSTATUS@ and @HTTPSTATUSINFO@ macros. 
Note that the template directory is served as though it were in the specified 
path - images and stylesheets should therefore go in the server's base 
directory.</P>

<p><b>Adding new macros to CMVP:</b><br>
Create the new .java file in the <I>com/planet_ink/coffee_mud/web/macros</I> directory; all classes
in this directory are loaded as macros by default.<br>
The new class should inherit from <code>StdWebMacro</code> in the 
<I>com.planet_ink.coffee_mud.web</I> package.<br>
The package of the new class should be <I>com.planet_ink.coffee_mud.web.macros</I>; the 
<code>name()</code> member should return the name of your new macro 
(it will be capitalised and the @ symbols added by StdWebMacro) - the name doesn't have to match 
the class name but it is recommended to avoid confusion.<br>
Finally, the <code>runMacro()</code> function returns the String data you wish to insert into the processed
output; it takes a single parameter, a reference to the <i>ProcessWebRequest</i> that is calling
the macro (you can use <code>.getWebServer()</code> on this parameter to get a reference to 
the web server, and <code>.getWebServer().getMUD()</code> to get a reference to the main MUD object).<br>
If <code>runMacro()</code> returns <I>null</I>, the string [Error] is used to replace the macro; also
note that <B>macros may not return other macros in the processed text.</B>
</p>
Example: this is the complete code for the <B>@HTTPCLIENTIP@</B> macro (HTTPclientIP.java):
<pre>package com.planet_ink.coffee_mud.web.macros;
import com.planet_ink.coffee_mud.interfaces.*;
import com.planet_ink.coffee_mud.common.*;
import com.planet_ink.coffee_mud.utils.*;

public class HTTPclientIP extends StdWebMacro 
{

	public String name() {return "HTTPclientIP";}	
	
	public String runMacro(ExternalHTTPRequests httpReq, String parms)
	{
		return httpReq.getHTTPclientIP();
	}

}
</pre>
The <code>.getHTTPclientIP()</code> member of ProcessWebRequest essentially just does this:
<pre>
	return sock.getInetAddress().getHostAddress();
</pre>
<P>
(don't be confused by the name <code>.getHostAddress()</code> - this just returns the 
dotted quad notation form of the address, whereas 
<code>.toString()</code> would attempt to do a reverse DNS(?) and 
return a meaningful name as well) </P>
<P>
If your macro is intended to be for the admin server only, you can override the
<code>.isAdminMacro()</code> member to return <code>true.</code></P>
<P><CODE></CODE>&nbsp;</P>   


</body>
</html>
